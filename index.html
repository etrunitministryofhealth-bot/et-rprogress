<!DOCTYPE html>
<html lang="en">
<head>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ET&R Funding Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
       :root {
    --primary: #2c6fbb;
    --primary-dark: #1a4f8c;
    --secondary: #4ca1af;
    --accent: #36b37e;
    --light: #f8f9fc;
    --dark: #2d3748;
    --gray: #718096;
    --light-gray: #e2e8f0;
    --danger: #e53e3e;
    --warning: #ecc94b;
    --success: #48bb78;
    --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
    color: #333;
    line-height: 1.6;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

/* Login Screen */
.login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    padding: 20px;
}

.login-form {
    background: white;
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 450px;
    box-shadow: var(--card-shadow);
    text-align: center;
    animation: fadeIn 0.8s ease;
}

.login-header {
    margin-bottom: 30px;
}

.login-header h1 {
    color: var(--primary);
    font-size: 2.2rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.login-header p {
    color: var(--gray);
    font-size: 1.1rem;
}

/* Enhanced Form Styling */
.form-group {
    margin-bottom: 25px;
    text-align: left;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}

.form-control {
    width: 100%;
    padding: 15px;
    border: 2px solid var(--light-gray);
    border-radius: 12px;
    font-size: 1rem;
    transition: var(--transition);
    background-color: #fff;
    color: var(--dark);
}

.form-control:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(44, 111, 187, 0.15);
    transform: translateY(-2px);
}

.form-control::placeholder {
    color: #a0aec0;
    opacity: 1;
}

/* Vote Number field styling */
.form-group input[list] {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
    padding-right: 45px;
    cursor: pointer;
}

.form-group input[type="text"][list]:hover {
    border-color: var(--secondary);
}

/* Enhanced dropdown arrow for select elements */
select.form-control {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
    padding-right: 45px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    cursor: pointer;
}

select.form-control:focus {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c6fbb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
}

/* Enhanced number input styling */
input[type="number"] {
    -moz-appearance: textfield;
}

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Enhanced textarea styling */
textarea.form-control {
    resize: vertical;
    min-height: 100px;
    max-height: 200px;
    font-family: inherit;
}

.btn {
    background: linear-gradient(to right, var(--primary), var(--primary-dark));
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-decoration: none;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 15px rgba(44, 111, 187, 0.3);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-outline:hover {
    background: var(--primary);
    color: white;
}

.btn-secondary {
    background: linear-gradient(to right, #e53e3e, #c53030);
}

.btn-success {
    background: linear-gradient(to right, var(--success), #2f9e5a);
}

/* Main App */
header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 20px 40px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo-icon {
    font-size: 32px;
    background: rgba(255, 255, 255, 0.15);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo h1 {
    font-size: 1.8rem;
    font-weight: 700;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 20px;
}

.user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-weight: bold;
    font-size: 18px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.nav-tabs {
    display: flex;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 15px;
    padding: 5px;
    margin-top: 20px;
    backdrop-filter: blur(5px);
}

.nav-tab {
    padding: 12px 25px;
    cursor: pointer;
    border-radius: 12px;
    transition: var(--transition);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nav-tab:hover, .nav-tab.active {
    background: white;
    color: var(--primary);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* Content Sections */
.section {
    padding: 30px;
}

.hidden {
    display: none;
}

/* Dashboard */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.dashboard-header h2 {
    font-size: 1.8rem;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 12px;
}

.filters-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    background: var(--light);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-size: 0.9rem;
    margin-bottom: 8px;
    color: var(--gray);
    font-weight: 600;
}

.search-box {
    display: flex;
    gap: 12px;
    grid-column: 1 / -1;
}

.search-box input {
    flex: 1;
}

/* Stats */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    border-left: 5px solid var(--primary);
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: rgba(44, 111, 187, 0.1);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    font-size: 24px;
    color: var(--primary);
}

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 5px;
}

.stat-card p {
    color: var(--gray);
    font-size: 1rem;
}

/* Projects Grid */
.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
}

.project-card {
    background: white;
    border-radius: 18px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.project-card:hover {
    transform: translateY(-7px);
    box-shadow: 0 20px 30px rgba(0, 0, 0, 0.12);
}

.project-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.project-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.project-header h3 {
    color: var(--primary);
    font-size: 1.3rem;
    margin-bottom: 5px;
}

.project-header span {
    color: var(--gray);
    font-size: 0.95rem;
}

.project-actions {
    display: flex;
    gap: 10px;
}

.project-description {
    margin-bottom: 20px;
    color: var(--dark);
    line-height: 1.7;
}

.financial-summary {
    background: var(--light);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.financial-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--light-gray);
}

.financial-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border: none;
}

.progress-container {
    margin: 20px 0;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-weight: 600;
}

.progress-bar {
    height: 12px;
    background: var(--light-gray);
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 10px;
}

.financial-progress .progress-fill {
    background: linear-gradient(90deg, var(--accent), #2f9e5a);
}

.project-remark {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--light-gray);
    font-style: italic;
    color: var(--gray);
}

.project-remark strong {
    color: var(--dark);
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 40px;
    flex-wrap: wrap;
}

/* Hospital Summary */
.hospital-summary {
    background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 5px solid var(--primary);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
}

.hospital-summary h3 {
    margin-bottom: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.summary-stats div {
    background: white;
    padding: 15px;
    border-radius: 12px;
    font-weight: 500;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
}

.summary-stats span {
    color: var(--primary);
    font-weight: 700;
    font-size: 1.2rem;
    margin-top: 5px;
}

/* Analytics */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.chart-container {
    background: white;
    border-radius: 18px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
}

.chart-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
}

.chart-title {
    margin-bottom: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.chart {
    height: 300px;
    position: relative;
}

/* Enhanced Modal Styling */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.4s ease;
    padding: 20px;
}

.modal-content {
    background: white;
    width: 95%;
    max-width: 900px;
    border-radius: 20px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.5s ease;
}

.modal-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 20px 20px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
}

.modal-header h2 {
    font-size: 1.6rem;
    display: flex;
    align-items: center;
    gap: 12px;
}

.close-modal {
    font-size: 28px;
    cursor: pointer;
    transition: var(--transition);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-modal:hover {
    transform: rotate(90deg);
    background: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 30px;
}

/* Vote Section Styles */
.votes-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.vote-table-container {
    background: white;
    border-radius: 18px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    overflow: hidden;
}

.vote-table-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
}

.table-container {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 15px;
    border: 1px solid var(--light-gray);
    border-radius: 12px;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

th {
    background-color: var(--primary);
    color: white;
    position: sticky;
    top: 0;
}

th, td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--light-gray);
}

tr:nth-child(even) {
    background-color: rgba(44, 111, 187, 0.05);
}

tr:hover {
    background-color: rgba(44, 111, 187, 0.1);
}

.vote-summary-card {
    background: white;
    border-radius: 18px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
}

.vote-summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
}

.vote-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.vote-stat {
    background: var(--light);
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
}

.vote-stat h4 {
    color: var(--primary);
    margin-bottom: 8px;
    font-size: 1rem;
}

.vote-stat .value {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary-dark);
}

.progress-indicator {
    height: 8px;
    background: var(--light-gray);
    border-radius: 10px;
    margin-top: 8px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 10px;
}

.vote-chart {
    height: 300px;
    position: relative;
    margin-top: 20px;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0; 
        transform: translateY(50px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0);
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Enhanced Form Row Layout */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-bottom: 25px;
}

.form-row .form-group {
    margin-bottom: 0;
}

/* Full Width Form Groups */
.form-group-full {
    grid-column: 1 / -1;
}

.form-group {
    margin-bottom: 25px;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
    padding-top: 25px;
    border-top: 1px solid var(--light-gray);
}

/* Enhanced styling for required fields */
.form-group label[for]::after {
    content: "*";
    color: var(--danger);
    margin-left: 5px;
    font-weight: bold;
}

/* Remove asterisk from optional fields */
.form-group:has(input:not([required])) label:after,
.form-group:has(textarea:not([required])) label:after {
    display: none;
}

/* Better visual feedback for form validation */
.form-control:invalid {
    border-color: var(--danger);
}

.form-control:valid {
    border-color: var(--success);
}

/* Enhanced error and success states */
.form-group.error .form-control {
    border-color: var(--danger);
    box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
}

.form-group.success .form-control {
    border-color: var(--success);
    box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
}

/* Error message styling */
.error-message {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.error-message::before {
    content: "⚠";
    font-size: 0.8rem;
}

/* Loading state for form submission */
.form-submitting {
    opacity: 0.7;
    pointer-events: none;
}

.form-submitting .btn {
    position: relative;
    color: transparent;
}

.form-submitting .btn:after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top: 2px solid #ffffff;
    animation: spin 1s linear infinite;
}

/* Form Section Styling */
.form-section {
    margin-bottom: 30px;
    padding: 25px;
    background: rgba(44, 111, 187, 0.02);
    border-radius: 12px;
    border-left: 4px solid var(--primary);
}

.form-section-title {
    color: var(--primary);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Custom styling for different input types */
input[type="number"].form-control {
    text-align: right;
}

textarea.form-control {
    font-family: inherit;
    line-height: 1.5;
}

select.form-control option {
    padding: 8px;
    background: white;
    color: var(--dark);
}

/* Enhanced datalist styling */
input[list]::-webkit-calendar-picker-indicator {
    display: none !important;
}

/* Loading Indicator */
.loading-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
}

.spinner {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 5px solid var(--primary);
    animation: spin 1s linear infinite;
}

/* Improved accessibility */
.form-control:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
}

/* Physical Progress field specific styling */
.form-group select#physicalProgress {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
    padding-right: 45px;
    cursor: pointer;
    transition: var(--transition);
}

.form-group select#physicalProgress:hover {
    border-color: var(--secondary);
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234ca1af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
}

.form-group select#physicalProgress:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(44, 111, 187, 0.15);
    transform: translateY(-2px);
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c6fbb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
}

/* Special styling for progress values */
.form-group select#physicalProgress option[value*="Not Started"] {
    color: var(--danger);
}

.form-group select#physicalProgress option[value*="Procurement"] {
    color: var(--warning);
}

.form-group select#physicalProgress option[value*="Work Done"] {
    color: var(--secondary);
}

.form-group select#physicalProgress option[value*="100"] {
    color: var(--success);
    font-weight: 600;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .votes-container {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 98%;
        max-width: none;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .modal-body {
        padding: 25px;
    }
}

@media (max-width: 768px) {
    .vote-table-container, .vote-summary-card {
        padding: 15px;
    }
    
    table {
        font-size: 0.85rem;
    }
    
    th, td {
        padding: 8px 10px;
    }
    
    .modal {
        padding: 10px;
    }
    
    .modal-content {
        width: 100%;
        max-height: 95vh;
    }
    
    .modal-header {
        padding: 20px;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-actions {
        flex-direction: column;
        gap: 12px;
    }
    
    .form-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .stats-container {
        grid-template-columns: 1fr;
    }
    
    .projects-grid {
        grid-template-columns: 1fr;
    }
    
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .header-content {
        flex-direction: column;
        gap: 15px;
    }
    
    .nav-tabs {
        width: 100%;
        overflow-x: auto;
    }
    
    .section {
        padding: 20px;
    }
}

@media (max-width: 480px) {
    .modal-header h2 {
        font-size: 1.3rem;
    }
    
    .form-group label {
        font-size: 0.9rem;
    }
    
    .form-control {
        padding: 12px;
        font-size: 0.95rem;
    }
    
    .btn {
        padding: 12px 20px;
        font-size: 0.95rem;
    }
}
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
    </div>

    <!-- Login Form -->
    <div class="login-container" id="loginForm">
        <div class="login-form">
            <div class="login-header">
                <h1><i class="fas fa-hospital"></i>  ET&R Funding Management System </h1>
                <p>Deputy Director General (ET&R-Ministry of Health)</p>
            </div>
            <div class="form-group">
                <label for="hospitalName"><i class="fas fa-hospital-user"></i> Select Hospital/User</label>
                <select id="hospitalName" class="form-control" required>
                    <option value="">Select Hospital/User</option>
                    <option value="admin">Administrator</option>
                    <option value="Ministry of Health">Ministry of Health</option>
                     <option value="ET&R Training D">ET&R Training D</option>
                    <option value="ET&R Training Q">ET&R Training Q</option>
                    <option value="ET&R Training R">ET&R Training S</option>
                    <option value="ET&R Training S">ET&R Training S</option>
                    <option value="ET&R Training J">ET&R Training J</option>
                    <option value="ET&R Training I">ET&R Training I</option>
                     <option value="ET&R Training K">ET&R Training K</option>
                    <option value="National Hospital Sri Lanka">National Hospital Sri Lanka</option>
                    <option value="Colombo South Teaching Hospital">Colombo South Teaching Hospital</option>
                    <option value="Lady Ridgeway Hospital">Lady Ridgeway Hospital</option>
                    <option value="Apeksha Hospital Maharagama">Apeksha Hospital Maharagama</option>
                    <option value="Colombo East Base Hospital Mulleriyawa">Colombo East Base Hospital Mulleriyawa</option>
                    <option value="Infections Diseases Hospital">Infections Diseases Hospital</option>
                    <option value="NIMH">NIMH</option>
                    <option value="De Soysa Hospital">De Soysa Hospital</option>
                    <option value="Castle Street Hospital for Women">Castle Street Hospital for Women</option>
                    <option value="National Eye Hospital">National Eye Hospital</option>
                    <option value="Institute of Oral Health-Maharagama">Institute of Oral Health-Maharagama</option>
                    <option value="National Blood Transfusion Service">National Blood Transfusion Service</option>
                    <option value="National Institute for Nephrology Dialysis and Transplantation - Maligawatta">National Institute for Nephrology Dialysis and Transplantation - Maligawatta</option>
                    <option value="Medical Research Institute">Medical Research Institute</option>
                    <option value="National Dental Hospital">National Dental Hospital</option>
                    <option value="Colombo North Teaching Hospital - Ragama">Colombo North Teaching Hospital - Ragama</option>
                    <option value="Rheumatology & Rehabilitation Hospital, Ragama">Rheumatology & Rehabilitation Hospital, Ragama</option>
                    <option value="District Hospital Kandana">District Hospital Kandana</option>
                    <option value="National Hospital for Respiratory Diseases, Welisara">National Hospital for Respiratory Diseases, Welisara</option>
                    <option value="Leprosy Hospital - Handala">Leprosy Hospital - Handala</option>
                    <option value="DGH Negombo (District General Hospital)">DGH Negombo (District General Hospital)</option>
                    <option value="Teaching Hospital Kalutara">Teaching Hospital Kalutara</option>
                    <option value="National Institute of Health Sciences Kalutara">National Institute of Health Sciences Kalutara</option>
                    <option value="National Hospital - Kandy">National Hospital - Kandy</option>
                    <option value="Base Hospital Gampola">Base Hospital Gampola </option>
                    <option value="Teaching Hospital Peradeniya">Teaching Hospital Peradeniya</option>
                    <option value="Sirimavo Bandaranayake Hospital - Peradeniya">Sirimavo Bandaranayake Hospital - Peradeniya</option>
                    <option value="District General Hospital Nawalapitiya">District General Hospital Nawalapitiya</option>
                    <option value="District General Hospital NuwaraEliya">District General Hospital NuwaraEliya</option>
                    <option value="District General Hospital Matale">District General Hospital Matale</option>
                    <option value="National Hospital - Galle (Karapitiya)">National Hospital - Galle (Karapitiya)</option>
                    <option value="German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)">German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)</option>
                    <option value="District General Hospital Matara">District General Hospital Matara</option>
                    <option value="District General Hospital Hambantota">District General Hospital Hambantota</option>
                    <option value="TH Jaffna">TH Jaffna</option>
                    <option value="Base Hospital Akkaraipattu">Base Hospital Akkaraipattu</option>
                    <option value="Ashroff Hospital - Kalmunai">Ashroff Hospital - Kalmunai</option>
                    <option value="Base Hospital Kalmunai North">Base Hospital Kalmunai North</option>
                    <option value="District General Hospital Ampara">District General Hospital Ampara</option>
                    <option value="Base Hospital Pottuvil">Base Hospital Pottuvil</option>
                    <option value="District General Hospital Trincomalee">District General Hospital Trincomalee</option>
                    <option value="District General Hospital Kantale">District General Hospital Kantale</option>
                    <option value="Teaching Hospital Batticaloa">Teaching Hospital Batticaloa</option>
                    <option value="District General Hospital Chilaw">District General Hospital Chilaw</option>
                    <option value="Teaching Hospital Kurunegala">Teaching Hospital Kurunegala</option>
                    <option value="Teaching Hospital Kuliyapitiya">Teaching Hospital Kuliyapitiya</option>
                    <option value="District General Hospital Polonnaruwa">District General Hospital Polonnaruwa</option>
                    <option value="China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)">China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)</option>
                    <option value="TH Anuradhapura">TH Anuradhapura</option>
                   <option value="TH Badulla">TH Badulla</option>
                    <option value="District General Hospital Monaragala">District General Hospital Monaragala </option>
                    <option value="District General Hospital Kegalle">District General Hospital Kegalle</option>
                    <option value="Teaching Hospital Ratnapura">Teaching Hospital Ratnapura</option>
                    <option value="District General Hospital Embilipitiya">District General Hospital Embilipitiya</option>
                    <option value="National STD/AIDS Control Programme">National STD/AIDS Control Programme</option>
                    <option value="Biomedical Engineering Services">Biomedical Engineering Services</option>
                    <option value="Epidemiology Unit">Epidemiology Unit</option>
                    <option value="National Cancer Control Programme">National Cancer Control Programme</option>
                    <option value="National Programme for Tuberculosis Control & Chest Diseases">National Programme for Tuberculosis Control & Chest Diseases</option>
                    <option value="Institute for Forensic Medicine & Toxicology">Institute for Forensic Medicine & Toxicology</option>
                    <option value="Health Promotion Bureau">Health Promotion Bureau</option>
                    <option value="Dengue Control Programme">Dengue Control Programme</option>
                    <option value="Anti Malaria Campaign">Anti Malaria Campaign</option>
                    <option value="Family Health Bureau">Family Health Bureau</option>
                    <option value="Anti Filariasis Campaign">Anti Filariasis Campaign</option>
                    <option value="Medical Supplies Division">Medical Supplies Division</option>
                    <option value="Public Health Veterinary Services">Public Health Veterinary Services</option>
                </select>
            </div>
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            <button class="btn" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <div class="login-footer">
                <p>Ministry of Health - Project Monitoring System</p>
            </div>
        </div>
    </div>

   <!-- Main Application -->
    <div class="container hidden" id="mainApp">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-hospital"></i>
                    </div>
                    <h1>ET&R Funding Management System</h1>
                </div>
                <div class="user-info">
                    <span id="userInfo">Logged in as: Admin</span>
                    <div class="user-avatar" id="userAvatar">A</div>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </div>
                <div class="nav-tab" onclick="showSection('forms')">
                    <i class="fas fa-file-alt"></i> Project Forms
                </div>
                <div class="nav-tab hidden" id="analyticsTab" onclick="showSection('analytics')">
                    <i class="fas fa-chart-bar"></i> Analytics
                </div>
                <div class="nav-tab hidden" id="votesTab" onclick="showSection('votes')">
                    <i class="fas fa-file-invoice-dollar"></i> Vote Summary
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div class="section" id="dashboardSection">
            <div class="dashboard-header">
                <h2><i class="fas fa-tachometer-alt"></i> Project Dashboard</h2>
                <div style="display: flex; gap: 15px;">
                    <button class="btn" onclick="openModal()">
                        <i class="fas fa-plus"></i> New Project
                    </button>
                    <button class="btn btn-outline" onclick="exportToExcel()">
                        <i class="fas fa-file-export"></i> Export to Excel
                    </button>
                </div>
            </div>
            
            <div class="filters-container">
                <div class="search-box">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search projects..." oninput="filterProjects()">
                    <button class="btn btn-outline" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                
                <div class="filter-group hidden" id="adminFilters">
                    <label><i class="fas fa-hospital"></i> Filter by Hospital</label>
                    <select id="hospitalFilter" class="form-control" onchange="filterProjects()">
                        <option value="">All Hospitals</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label><i class="fas fa-tasks"></i> Progress Status</label>
                    <select id="progressFilter" class="form-control" onchange="filterProjects()">
                        <option value="">All Progress</option>
                        <option value="0-25">0-25%</option>
                        <option value="26-50">26-50%</option>
                        <option value="51-75">51-75%</option>
                        <option value="76-99">76-99%</option>
                        <option value="100">Completed (100%)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label><i class="fas fa-sort"></i> Sort By</label>
                    <select id="sortSelect" class="form-control" onchange="filterProjects()">
                        <option value="date-desc">Date (Newest First)</option>
                        <option value="date-asc">Date (Oldest First)</option>
                        <option value="progress-asc">Progress (Low to High)</option>
                        <option value="progress-desc">Progress (High to Low)</option>
                        <option value="name-asc">Hospital Name (A-Z)</option>
                        <option value="name-desc">Hospital Name (Z-A)</option>
                    </select>
                </div>
            </div>
            
            <div id="hospitalSummary"></div>
            
            <div id="dashboardStats" class="stats-container"></div>
            
            <div id="projectsGrid" class="projects-grid"></div>
            
            <div id="paginationControls" class="pagination"></div>
        </div>

        <!-- Forms Section -->
        <div class="section hidden" id="formsSection">
            <div class="dashboard-header">
                <h2><i class="fas fa-file-alt"></i> Project Management</h2>
                <button class="btn" onclick="openModal()">
                    <i class="fas fa-plus"></i> Add New Project
                </button>
            </div>
            
            <div class="hospital-summary" style="margin-top: 30px;">
                <h3><i class="fas fa-info-circle"></i> Project Management</h3>
                <p>Use the "Add New Project" button to create a new project record. Edit existing projects by clicking the Edit button on the project card in the Dashboard.</p>
                <div style="display: flex; justify-content: center; margin-top: 30px;">
                    <img src="https://cdn.pixabay.com/photo/2018/03/10/12/00/paper-3213924_960_720.jpg" alt="Project Management" style="max-width: 100%; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                </div>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div class="section hidden" id="analyticsSection">
            <div class="dashboard-header">
                <h2><i class="fas fa-chart-bar"></i> Project Analytics</h2>
                <div class="filter-group" style="max-width: 300px;">
                    <label><i class="fas fa-hospital"></i> Hospital Filter</label>
                    <select id="analyticsHospitalFilter" class="form-control" onchange="loadAnalytics()">
                        <option value="">All Hospitals</option>
                    </select>
                </div>
            </div>
            
            <div class="analytics-grid">
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-building"></i> Projects by Hospital</h3>
                    <div class="chart">
                        <canvas id="hospitalChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-tasks"></i> Projects by Progress</h3>
                    <div class="chart">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-money-bill-wave"></i> Financial Allocation vs Spending</h3>
                    <div class="chart">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> Progress Distribution</h3>
                    <div class="chart">
                        <canvas id="progressDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vote Section -->
        <div class="section hidden" id="votesSection">
            <div class="dashboard-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> Vote Summary Dashboard</h2>
                <div class="filter-group" style="max-width: 300px;">
                    <label><i class="fas fa-filter"></i> Filter Votes</label>
                    <select id="voteFilter" class="form-control" onchange="loadVoteDashboard()">
                        <option value="">All Votes</option>
                    </select>
                </div>
                <button class="btn btn-outline" onclick="exportVoteSummaryToExcel()">
                    <i class="fas fa-file-export"></i> Export to Excel
                </button>
            </div>
            
            <div class="votes-container">
                <div class="vote-table-container">
                    <h3><i class="fas fa-table"></i> Vote Financial Summary</h3>
                    <div class="table-container">
                        <table id="voteTable">
                            <thead>
                                <tr>
                                    <th>Vote Number</th>
                                    <th>Projects</th>
                                    <th>Allocation (Rs.)</th>
                                    <th>Awarded (Rs.)</th>
                                    <th>Bills Paid (Rs.)</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="vote-summary-card">
                    <h3><i class="fas fa-chart-pie"></i> Vote Distribution</h3>
                    <div class="vote-stats" id="voteStats">
                        <!-- Stats will be populated dynamically -->
                    </div>
                    <div class="vote-chart">
                        <canvas id="voteChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-file-medical"></i> Add New Project</h2>
                <div class="close-modal" onclick="closeModal()">&times;</div>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hospitalNameForm"><i class="fas fa-hospital"></i> Hospital Name *</label>
                            <select id="hospitalNameForm" class="form-control" required>
                                <option value="">Select Hospital</option>
                                <option value="Ministry of Health">Ministry of Health</option>
                                <option value="ET&R Training D">ET&R Training D</option>
                    <option value="ET&R Training Q">ET&R Training Q</option>
                    <option value="ET&R Training R">ET&R Training R</option>
                    <option value="ET&R Training S">ET&R Training S</option>
                    <option value="ET&R Training J">ET&R Training J</option>
                    <option value="ET&R Training I">ET&R Training I</option>
                                <option value="ET&R Training K">ET&R Training K</option>
                     
                                <option value="National Hospital Sri Lanka">National Hospital Sri Lanka</option>
                                <option value="Colombo South Teaching Hospital">Colombo South Teaching Hospital</option>
                                <option value="Lady Ridgeway Hospital">Lady Ridgeway Hospital</option>
                                <option value="Apeksha Hospital Maharagama">Apeksha Hospital Maharagama</option>
                                <option value="Colombo East Base Hospital Mulleriyawa">Colombo East Base Hospital Mulleriyawa</option>
                                <option value="Infections Diseases Hospital">Infections Diseases Hospital</option>
                                <option value="NIMH">NIMH</option>
                                <option value="De Soysa Hospital">De Soysa Hospital</option>
                                <option value="Castle Street Hospital for Women">Castle Street Hospital for Women</option>
                                <option value="National Eye Hospital">National Eye Hospital</option>
                                <option value="Institute of Oral Health-Maharagama">Institute of Oral Health-Maharagama</option>
                                <option value="National Blood Transfusion Service">National Blood Transfusion Service</option>
                                <option value="National Institute for Nephrology Dialysis and Transplantation - Maligawatta">National Institute for Nephrology Dialysis and Transplantation - Maligawatta</option>
                                <option value="Medical Research Institute">Medical Research Institute</option>
                                <option value="National Dental Hospital">National Dental Hospital</option>
                                <option value="Colombo North Teaching Hospital - Ragama">Colombo North Teaching Hospital - Ragama</option>
                                <option value="Rheumatology & Rehabilitation Hospital, Ragama">Rheumatology & Rehabilitation Hospital, Ragama</option>
                                <option value="District Hospital Kandana">District Hospital Kandana</option>
                                <option value="National Hospital for Respiratory Diseases, Welisara">National Hospital for Respiratory Diseases, Welisara</option>
                                <option value="Leprosy Hospital - Handala">Leprosy Hospital - Handala</option>
                                <option value="DGH Negombo (District General Hospital)">DGH Negombo (District General Hospital)</option>
                                <option value="Teaching Hospital Kalutara">Teaching Hospital Kalutara</option>
                                <option value="National Institute of Health Sciences Kalutara">National Institute of Health Sciences Kalutara</option>
                                <option value="National Hospital - Kandy">National Hospital - Kandy</option>
                                <option value="Base Hospital Gampola">Base Hospital Gampola </option>
                                <option value="Teaching Hospital Peradeniya">Teaching Hospital Peradeniya</option>
                                <option value="Sirimavo Bandaranayake Hospital - Peradeniya">Sirimavo Bandaranayake Hospital - Peradeniya</option>
                                <option value="District General Hospital Nawalapitiya">District General Hospital Nawalapitiya</option>
                                <option value="District General Hospital NuwaraEliya">District General Hospital NuwaraEliya</option>
                                <option value="District General Hospital Matale">District General Hospital Matale</option>
                                <option value="National Hospital - Galle (Karapitiya)">National Hospital - Galle (Karapitiya)</option>
                                <option value="German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)">German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)</option>
                                <option value="District General Hospital Matara">District General Hospital Matara</option>
                                <option value="District General Hospital Hambantota">District General Hospital Hambantota</option>
                                <option value="TH Jaffna">TH Jaffna</option>
                                <option value="Base Hospital Akkaraipattu">Base Hospital Akkaraipattu</option>
                                <option value="Ashroff Hospital - Kalmunai">Ashroff Hospital - Kalmunai</option>
                                <option value="Base Hospital Kalmunai North">Base Hospital Kalmunai North</option>
                                <option value="District General Hospital Ampara">District General Hospital Ampara</option>
                                <option value="Base Hospital Pottuvil">Base Hospital Pottuvil</option>
                                <option value="District General Hospital Trincomalee">District General Hospital Trincomalee</option>
                                <option value="District General Hospital Kantale">District General Hospital Kantale</option>
                                <option value="Teaching Hospital Batticaloa">Teaching Hospital Batticaloa</option>
                                <option value="District General Hospital Chilaw">District General Hospital Chilaw</option>
                                <option value="Teaching Hospital Kurunegala">Teaching Hospital Kurunegala</option>
                                <option value="Teaching Hospital Kuliyapitiya">Teaching Hospital Kuliyapitiya</option>
                                <option value="District General Hospital Polonnaruwa">District General Hospital Polonnaruwa</option>
                                <option value="China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)">China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)</option>
                                <option value="TH Anuradhapura">TH Anuradhapura</option>
                               <option value="TH Badulla">TH Badulla</option>
                                <option value="District General Hospital Monaragala">District General Hospital Monaragala </option>
                                <option value="District General Hospital Kegalle">District General Hospital Kegalle</option>
                                <option value="Teaching Hospital Ratnapura">Teaching Hospital Ratnapura</option>
                                <option value="District General Hospital Embilipitiya">District General Hospital Embilipitiya</option>
                                <option value="National STD/AIDS Control Programme">National STD/AIDS Control Programme</option>
                                <option value="Biomedical Engineering Services">Biomedical Engineering Services</option>
                                <option value="Epidemiology Unit">Epidemiology Unit</option>
                                <option value="National Cancer Control Programme">National Cancer Control Programme</option>
                                <option value="National Programme for Tuberculosis Control & Chest Diseases">National Programme for Tuberculosis Control & Chest Diseases</option>
                                <option value="Institute for Forensic Medicine & Toxicology">Institute for Forensic Medicine & Toxicology</option>
                                <option value="Health Promotion Bureau">Health Promotion Bureau</option>
                                <option value="Dengue Control Programme">Dengue Control Programme</option>
                                <option value="Anti Malaria Campaign">Anti Malaria Campaign</option>
                                <option value="Family Health Bureau">Family Health Bureau</option>
                                <option value="Anti Filariasis Campaign">Anti Filariasis Campaign</option>
                                <option value="Medical Supplies Division">Medical Supplies Division</option>
                                <option value="Public Health Veterinary Services">Public Health Veterinary Services</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
  <label for="vote"><i class="fas fa-file-invoice"></i> Vote Number *</label>
  <select id="vote" class="form-control" required>
    <option value="">-- Select Vote Number --</option>
     <option value="111-1-5-8-2103(11) Lab Apparatus ">
      111-1-5-8-2103(11) Lab Apparatus
    </option>

 <option value="111-2-17-1-2507(11) Research and Developments ">
     111-2-17-1-2507-0(11) Research and Developments
    </option>

 <option value="111-2-20-1-2102(11) Furniture and Office Equipment ">
     111-2-20-1-2102(11) Furniture and Office Equipment
    </option>

<option value="111-2-20-1-2401(11) Training ">
     111-2-20-1-2401(11) Training
    </option>

<option value="111-2-20-1-2506(11) Infrastructure Development  ">
     111-2-20-1-2506(11) Infrastructure Development
    </option>
  </select>
</div>

                    
                    <div class="form-group">
                        <label for="jobDescription"><i class="fas fa-file-alt"></i> Job Description *</label>
                        <textarea id="jobDescription" class="form-control" placeholder="Describe the project..." required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allocationAmount"><i class="fas fa-money-bill-wave"></i> Allocation Amount (Rs.) *</label>
                            <input type="number" id="allocationAmount" class="form-control" placeholder="Enter amount" min="0" step="1000" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="estimateAmount"><i class="fas fa-calculator"></i> Estimate Amount (Rs.) *</label>
                            <input type="number" id="estimateAmount" class="form-control" placeholder="Enter amount" min="0" step="1000" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="awardingAmount"><i class="fas fa-award"></i> Awarding Amount (Rs.) *</label>
                            <input type="number" id="awardingAmount" class="form-control" placeholder="Enter amount" min="0" step="1000" required>
                        </div>
                        
              <div class="form-group">
  <label for="physicalProgress"><i class="fas fa-tasks"></i> Physical Progress (%)</label>
  <select id="physicalProgress" class="form-control" required>
    <option value="">-- Select the Progress Level --</option>
    <option value="5% - Estimate Prepared (01)">5% - Estimate Prepared (01)</option>
    <option value="10% - Estimate Approved (02)">10% - Estimate Approved (02)</option>
    <option value="15% - Bid Document Prepared (03)">15% - Bid Document Prepared (03)</option>
    <option value="20% - Bid Called (04)">20% - Bid Called (04)</option>
    <option value="25% - Bid Closed (05)">25% - Bid Closed (05)</option>
    <option value="30% - TEC Appointed (06)">30% - TEC Appointed (06)</option>
    <option value="35% - TEC Completed (07)">35% - TEC Completed (07)</option>
    <option value="40% - Procurement Decision Taken (08)">40% - Procurement Decision Taken (08)</option>
    <option value="45% - Appeal Period (09)">45% - Appeal Period (09)</option>
    <option value="50% - Job Awarded (10)">50% - Job Awarded (10)</option>
    <option value="55% - 25% of Job Completed (11)">55% - 25% of Job Completed (11)</option>
    <option value="60% - 50% of Job Completed (12)">60% - 50% of Job Completed (12)</option>
    <option value="80% - 75% of Job Completed (13)">80% - 75% of Job Completed (13)</option>
    <option value="95% - 95% of Job Completed (14)">95% - 95% of Job Completed (14)</option>
    <option value="100% - Job Handed Over to the Client (15)">100% - Job Handed Over to the Client (15)</option>
  </select>
</div>

                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="advanceAmount"><i class="fas fa-hand-holding-usd"></i> Advance Amount (Rs.)</label>
                            <input type="number" id="advanceAmount" class="form-control" placeholder="Enter amount" min="0" step="1000">
                        </div>
                        
                        <div class="form-group">
                            <label for="bill1"><i class="fas fa-file-invoice-dollar"></i> 1st Bill Amount (Rs.)</label>
                            <input type="number" id="bill1" class="form-control" placeholder="Enter amount" min="0" step="1000">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bill2"><i class="fas fa-file-invoice-dollar"></i> 2nd Bill Amount (Rs.)</label>
                            <input type="number" id="bill2" class="form-control" placeholder="Enter amount" min="0" step="1000">
                        </div>
                        
                        <div class="form-group">
                            <label for="bill3"><i class="fas fa-file-invoice-dollar"></i> 3rd Bill Amount (Rs.)</label>
                            <input type="number" id="bill3" class="form-control" placeholder="Enter amount" min="0" step="1000">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bill4"><i class="fas fa-file-invoice-dollar"></i> 4th Bill Amount (Rs.)</label>
                            <input type="number" id="bill4" class="form-control" placeholder="Enter amount" min="0" step="1000">
                        </div>
                        
                        <div class="form-group">
                            <label for="bill5"><i class="fas fa-file-invoice-dollar"></i> Final Bill Amount (Rs.)</label>
                            <input type="number" id="bill5" class="form-control" placeholder="Enter amount" min="0" step="1000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="remark"><i class="fas fa-comment"></i> Remarks</label>
                        <textarea id="remark" class="form-control" placeholder="Additional notes..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn" onclick="saveProject()">
                            <i class="fas fa-save"></i> Save Project
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
     <script>
        // Global variables
let currentUser = null;
let projects = [];
let editingProject = null;
let filteredProjects = [];
let currentPage = 1;
const projectsPerPage = 5;
let hospitals = [
    "National Hospital Sri Lanka",
    "Ministry of Health",
    "ET&R Training D",
    "ET&R Training Q",
    "ET&R Training R",
    "ET&R Training S",
    "ET&R Training J",
    "ET&R Training I",
     "ET&R Training K",
    
    "Colombo South Teaching Hospital",
    "Lady Ridgeway Hospital",
    "Apeksha Hospital Maharagama",
    "Colombo East Base Hospital Mulleriyawa",
    "Infections Diseases Hospital",
    "NIMH",
    "De Soysa Hospital",
    "Castle Street Hospital for Women",
    "National Eye Hospital",
    "Institute of Oral Health-Maharagama",
    "National Blood Transfusion Service",
    "National Institute for Nephrology Dialysis and Transplantation - Maligawatta",
    "Medical Research Institute",
    "National Dental Hospital",
    "Colombo North Teaching Hospital - Ragama",
    "Rheumatology & Rehabilitation Hospital, Ragama",
    "District Hospital Kandana",
    "National Hospital for Respiratory Diseases, Welisara",
    "Leprosy Hospital - Handala",
    "DGH Negombo (District General Hospital)",
    "Teaching Hospital Kalutara",
    "National Institute of Health Sciences Kalutara",
    "National Hospital - Kandy",
    "Base Hospital Gampola",
    "Teaching Hospital Peradeniya",
    "Sirimavo Bandaranayake Hospital - Peradeniya",
    "District General Hospital Nawalapitiya",
    "District General Hospital NuwaraEliya",
    "District General Hospital Matale",
    "National Hospital - Galle (Karapitiya)",
    "German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)",
    "District General Hospital Matara",
    "District General Hospital Hambantota",
    "TH Jaffna",
    "Base Hospital Akkaraipattu",
    "Ashroff Hospital - Kalmunai",
    "Base Hospital Kalmunai North",
    "District General Hospital Ampara",
    "Base Hospital Pottuvil",
    "District General Hospital Trincomalee",
    "District General Hospital Kantale",
    "Teaching Hospital Batticaloa",
    "District General Hospital Chilaw",
    "Teaching Hospital Kurunegala",
    "Teaching Hospital Kuliyapitiya",
    "District General Hospital Polonnaruwa",
    "China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)",
    "TH Anuradhapura",
    "TH Badulla",
    "District General Hospital Monaragala",
    "District General Hospital Kegalle",
    "Teaching Hospital Ratnapura",
    "District General Hospital Embilipitiya",
    "National STD/AIDS Control Programme",
    "Biomedical Engineering Services",
    "Epidemiology Unit",
    "National Cancer Control Programme",
    "National Programme for Tuberculosis Control & Chest Diseases",
    "Institute for Forensic Medicine & Toxicology",
    "Health Promotion Bureau",
    "Dengue Control Programme",
    "Anti Malaria Campaign",
    "Family Health Bureau",
    "Anti Filariasis Campaign",
    "Medical Supplies Division",
    "Public Health Veterinary Services"
];

let hospitalChart = null;
let progressChart = null;
let financialChart = null;
let progressDistributionChart = null;
let voteChart = null;

// Navigation function - FIXED
function showSection(section) {
    // Hide all sections
    document.getElementById('dashboardSection').classList.add('hidden');
    document.getElementById('formsSection').classList.add('hidden');
    document.getElementById('analyticsSection').classList.add('hidden');
    document.getElementById('votesSection').classList.add('hidden'); // Added this line
    
    // Remove active class from all tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected section and activate tab
    if (section === 'dashboard') {
        document.getElementById('dashboardSection').classList.remove('hidden');
        document.querySelector('[onclick="showSection(\'dashboard\')"]').classList.add('active');
        loadProjects();
    } else if (section === 'forms') {
        document.getElementById('formsSection').classList.remove('hidden');
        document.querySelector('[onclick="showSection(\'forms\')"]').classList.add('active');
    } else if (section === 'analytics') {
        document.getElementById('analyticsSection').classList.remove('hidden');
        document.querySelector('[onclick="showSection(\'analytics\')"]').classList.add('active');
        loadAnalytics();
    } else if (section === 'votes') { // Added this section
        document.getElementById('votesSection').classList.remove('hidden');
        document.querySelector('[onclick="showSection(\'votes\')"]').classList.add('active');
        loadVoteDashboard();
    }
}

// Configuration - Replace with your Google Apps Script Web App URL
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw-oAeQOYk7134o4oaWjraQNbV6qKH2nkBRCJkhIce9L3hrrpMlJZCE6Uuz2LSx-Wa2/exec';

// Predefined user credentials
const USERS = {
    'admin': { password: 'admin123', type: 'admin', name: 'Administrator' },
    // Hospitals and Institutions with unique 4-character passwords
    'Ministry of Health': { password: 'MOH1', type: 'hospital', name: 'Ministry of Health' },
     'ET&R Training D': { password: 'ET&R0', type: 'hospital', name: 'ET&R Training D' },
    'ET&R Training Q': { password: 'ET&R1', type: 'hospital', name: 'ET&R Training Q' },
     'ET&R Training R': { password: 'ET&R2', type: 'hospital', name: 'ET&R Training R' },
     'ET&R Training S': { password: 'ET&R3', type: 'hospital', name: 'ET&R Training S' },
     'ET&R Training J': { password: 'ET&R4', type: 'hospital', name: 'ET&R Training J' },
     'ET&R Training I': { password: 'ET&R5', type: 'hospital', name: 'ET&R Training I' },
       'ET&R Training K': { password: 'ET&R6', type: 'hospital', name: 'ET&R Training K' },
     
    'National Hospital Sri Lanka': { password: 'NY70', type: 'hospital', name: 'National Hospital Sri Lanka' },
    'Colombo South Teaching Hospital': { password: 'FL51', type: 'hospital', name: 'Colombo South Teaching Hospital' },
    'Lady Ridgeway Hospital': { password: 'YI96', type: 'hospital', name: 'Lady Ridgeway Hospital' },
    'Apeksha Hospital Maharagama': { password: 'AS66', type: 'hospital', name: 'Apeksha Hospital Maharagama' },
    'Colombo East Base Hospital Mulleriyawa': { password: 'PX99', type: 'hospital', name: 'Colombo East Base Hospital Mulleriyawa' },
    'Infections Diseases Hospital': { password: 'KD13', type: 'hospital', name: 'Infections Diseases Hospital' },
    'NIMH': { password: 'DI93', type: 'hospital', name: 'NIMH' },
    'De Soysa Hospital': { password: 'KX65', type: 'hospital', name: 'De Soysa Hospital' },
    'Castle Street Hospital for Women': { password: 'OJ82', type: 'hospital', name: 'Castle Street Hospital for Women' },
    'National Eye Hospital': { password: 'VV32', type: 'hospital', name: 'National Eye Hospital' },
    'Institute of Oral Health-Maharagama': { password: 'GX59', type: 'hospital', name: 'Institute of Oral Health-Maharagama' },
    'National Blood Transfusion Service': { password: 'UY80', type: 'hospital', name: 'National Blood Transfusion Service' },
    'National Institute for Nephrology Dialysis and Transplantation - Maligawatta': { password: 'GA82', type: 'hospital', name: 'National Institute for Nephrology Dialysis and Transplantation - Maligawatta' },
    'Medical Research Institute': { password: 'FS03', type: 'hospital', name: 'Medical Research Institute' },
    'National Dental Hospital': { password: 'JV54', type: 'hospital', name: 'National Dental Hospital' },
    'Colombo North Teaching Hospital - Ragama': { password: 'FK38', type: 'hospital', name: 'Colombo North Teaching Hospital - Ragama' },
    'Rheumatology & Rehabilitation Hospital, Ragama': { password: 'PC43', type: 'hospital', name: 'Rheumatology & Rehabilitation Hospital, Ragama' },
    'District Hospital Kandana': { password: 'DG62', type: 'hospital', name: 'District Hospital Kandana' },
    'National Hospital for Respiratory Diseases, Welisara': { password: 'CT99', type: 'hospital', name: 'National Hospital for Respiratory Diseases, Welisara' },
    'Leprosy Hospital - Handala': { password: 'BZ66', type: 'hospital', name: 'Leprosy Hospital - Handala' },
    'DGH Negombo (District General Hospital)': { password: 'JU15', type: 'hospital', name: 'DGH Negombo (District General Hospital)' },
    'Teaching Hospital Kalutara': { password: 'AC80', type: 'hospital', name: 'Teaching Hospital Kalutara' },
    'National Institute of Health Sciences Kalutara': { password: 'EK13', type: 'hospital', name: 'National Institute of Health Sciences Kalutara' },
    'National Hospital - Kandy': { password: 'FQ00', type: 'hospital', name: 'National Hospital - Kandy' },
    'Base Hospital Gampola': { password: 'HO03', type: 'hospital', name: 'Base Hospital Gampola' },
    'Teaching Hospital Peradeniya': { password: 'GL91', type: 'hospital', name: 'Teaching Hospital Peradeniya' },
    'Sirimavo Bandaranayake Hospital - Peradeniya': { password: 'EU46', type: 'hospital', name: 'Sirimavo Bandaranayake Hospital - Peradeniya' },
    'District General Hospital Nawalapitiya': { password: 'QU71', type: 'hospital', name: 'District General Hospital Nawalapitiya' },
    'District General Hospital NuwaraEliya': { password: 'NR42', type: 'hospital', name: 'District General Hospital NuwaraEliya' },
    'District General Hospital Matale': { password: 'KD59', type: 'hospital', name: 'District General Hospital Matale' },
    'National Hospital - Galle (Karapitiya)': { password: 'FH55', type: 'hospital', name: 'National Hospital - Galle (Karapitiya)' },
    'German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)': { password: 'KB56', type: 'hospital', name: 'German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)' },
    'District General Hospital Matara': { password: 'KL66', type: 'hospital', name: 'District General Hospital Matara' },
    'District General Hospital Hambantota': { password: 'SW36', type: 'hospital', name: 'District General Hospital Hambantota' },
    'TH Jaffna': { password: 'FO55', type: 'hospital', name: 'TH Jaffna' },
    'Base Hospital Akkaraipattu': { password: 'JJ19', type: 'hospital', name: 'Base Hospital Akkaraipattu' },
    'Ashroff Hospital - Kalmunai': { password: 'HU87', type: 'hospital', name: 'Ashroff Hospital - Kalmunai' },
    'Base Hospital Kalmunai North': { password: 'NQ73', type: 'hospital', name: 'Base Hospital Kalmunai North' },
    'District General Hospital Ampara': { password: 'DP44', type: 'hospital', name: 'District General Hospital Ampara' },
    'Base Hospital Pottuvil': { password: 'GM53', type: 'hospital', name: 'Base Hospital Pottuvil' },
    'District General Hospital Trincomalee': { password: 'CS47', type: 'hospital', name: 'District General Hospital Trincomalee' },
    'District General Hospital Kantale': { password: 'KM95', type: 'hospital', name: 'District General Hospital Kantale' },
    'Teaching Hospital Batticaloa': { password: 'NS13', type: 'hospital', name: 'Teaching Hospital Batticaloa' },
    'District General Hospital Chilaw': { password: 'RM10', type: 'hospital', name: 'District General Hospital Chilaw' },
    'Teaching Hospital Kurunegala': { password: 'AL07', type: 'hospital', name: 'Teaching Hospital Kurunegala' },
    'Teaching Hospital Kuliyapitiya': { password: 'RO70', type: 'hospital', name: 'Teaching Hospital Kuliyapitiya' },
    'District General Hospital Polonnaruwa': { password: 'IX38', type: 'hospital', name: 'District General Hospital Polonnaruwa' },
    'China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)': { password: 'PQ56', type: 'hospital', name: 'China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)' },
    'TH Anuradhapura': { password: 'JS41', type: 'hospital', name: 'TH Anuradhapura' },
    'TH Badulla': { password: 'RG46', type: 'hospital', name: 'TH Badulla' },
    'District General Hospital Monaragala': { password: 'LT92', type: 'hospital', name: 'District General Hospital Monaragala' },
    'District General Hospital Kegalle': { password: 'RB97', type: 'hospital', name: 'District General Hospital Kegalle' },
    'Teaching Hospital Ratnapura': { password: 'VG00', type: 'hospital', name: 'Teaching Hospital Ratnapura' },
    'District General Hospital Embilipitiya': { password: 'OS11', type: 'hospital', name: 'District General Hospital Embilipitiya' },
    'National STD/AIDS Control Programme': { password: 'AJ29', type: 'hospital', name: 'National STD/AIDS Control Programme' },
    'Biomedical Engineering Services': { password: 'DD18', type: 'hospital', name: 'Biomedical Engineering Services' },
    'Epidemiology Unit': { password: 'ZS11', type: 'hospital', name: 'Epidemiology Unit' },
    'National Cancer Control Programme': { password: 'DP63', type: 'hospital', name: 'National Cancer Control Programme' },
    'National Programme for Tuberculosis Control & Chest Diseases': { password: 'XK38', type: 'hospital', name: 'National Programme for Tuberculosis Control & Chest Diseases' },
    'Institute for Forensic Medicine & Toxicology': { password: 'VQ40', type: 'hospital', name: 'Institute for Forensic Medicine & Toxicology' },
    'Health Promotion Bureau': { password: 'ZJ89', type: 'hospital', name: 'Health Promotion Bureau' },
    'Dengue Control Programme': { password: 'EP19', type: 'hospital', name: 'Dengue Control Programme' },
    'Anti Malaria Campaign': { password: 'KT89', type: 'hospital', name: 'Anti Malaria Campaign' },
    'Family Health Bureau': { password: 'KE01', type: 'hospital', name: 'Family Health Bureau' },
    'Anti Filariasis Campaign': { password: 'NA67', type: 'hospital', name: 'Anti Filariasis Campaign' },
    'Medical Supplies Division': { password: 'XP08', type: 'hospital', name: 'Medical Supplies Division' },
    'Public Health Veterinary Services': { password: 'FV19', type: 'hospital', name: 'Public Health Veterinary Services' }
};

// Authentication Function - FIXED
async function login() {
    const username = document.getElementById('hospitalName').value;
    const password = document.getElementById('password').value;

    if (!username || !password) {
        alert('Please enter both username and password');
        return;
    }

    try {
        showLoading(true);
        
        // Check credentials
        if (USERS[username] && USERS[username].password === password) {
            currentUser = USERS[username];
            
            // Hide login form and show main app
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `Logged in as: ${currentUser.name}`;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            
            // Show/hide admin-only features - FIXED
            if (currentUser.type === 'admin') {
                document.getElementById('adminFilters').classList.remove('hidden');
                document.getElementById('analyticsTab').classList.remove('hidden');
                document.getElementById('votesTab').classList.remove('hidden'); // Show votes tab for admin
                populateHospitalFilter();
            } else {
                document.getElementById('adminFilters').classList.add('hidden');
                document.getElementById('analyticsTab').classList.add('hidden');
                document.getElementById('votesTab').classList.add('hidden'); // Hide votes tab for hospitals
            }
            
            // Load dashboard
            await loadDashboard();
        } else {
            alert('Invalid username or password');
        }
    } catch (error) {
        console.error('Login error:', error);
        alert('Login error. Please try again.');
    } finally {
        showLoading(false);
    }
}

// Populate hospital filter dropdown
function populateHospitalFilter() {
    const hospitalFilter = document.getElementById('hospitalFilter');
    hospitalFilter.innerHTML = '<option value="">All Hospitals</option>';
    
    hospitals.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital;
        option.textContent = hospital;
        hospitalFilter.appendChild(option);
    });
}

// Load Dashboard Function
async function loadDashboard() {
    await loadProjects(); // Call loadProjects instead of duplicating code
}

// Load Projects Function - FIXED
async function loadProjects() {
    try {
        showLoading(true);
        
        if (GAS_WEB_APP_URL && GAS_WEB_APP_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
            // Try to load from Google Apps Script
            const projectsResponse = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=getProjects&data=${encodeURIComponent(JSON.stringify({
                    userType: currentUser.type,
                    hospitalName: currentUser.name
                }))}`
            });

            const projectsResult = await projectsResponse.json();
            
            if (projectsResult.success) {
                projects = projectsResult.projects.map(project => ({
                    id: project.ID,
                    hospitalNameForm: project['Hospital Name'],
                    vote: project.Vote,
                    allocationAmount: project['Allocation Amount'] || 0,
                    jobDescription: project['Job Description'],
                    estimateAmount: project['Estimate Amount'] || 0,
                    awardingAmount: project['Awarding Amount'] || 0,
                    physicalProgress: project['Physical Progress'] || 0,
                    advanceAmount: project['Advance Amount'] || 0,
                    bill1: project['1st Bill'] || 0,
                    bill2: project['2nd Bill'] || 0,
                    bill3: project['3rd Bill'] || 0,
                    bill4: project['4th Bill'] || 0,
                    bill5: project['5th Bill'] || 0,
                    financialProgress: project['Financial Progress'] || 0,
                    remark: project.Remark || '',
                    createdDate: project['Created Date'] ? new Date(project['Created Date']) : new Date()
                }));
            } else {
                // Fall back to sample data if backend fails
                loadSampleData();
            }
        } else {
            // Load sample data if no backend configured
            loadSampleData();
        }
        
        // Add created date to sample data
        projects.forEach(project => {
            if (!project.createdDate) {
                project.createdDate = new Date();
            }
        });
        
        displayStats();
        filterProjects();
        
    } catch (error) {
        console.error('Load dashboard error:', error);
        // Fall back to sample data on error
        loadSampleData();
        displayStats();
        filterProjects();
    } finally {
        showLoading(false);
    }
}

// Load sample data for demonstration
function loadSampleData() {
    projects = [
        {
            id: 1,
            hospitalNameForm: 'National Hospital Sri Lanka',
            vote: '111-1-5-2001(11) Building Rehabilitation-Hospital',
            allocationAmount: 5000000,
            jobDescription: 'Emergency Ward Renovation',
            estimateAmount: 4800000,
            awardingAmount: 4500000,
            physicalProgress: 75,
            advanceAmount: 1000000,
            bill1: 800000,
            bill2: 900000,
            bill3: 700000,
            bill4: 0,
            bill5: 0,
            remark: 'Work in progress',
            createdDate: new Date(2023, 5, 15)
        },
        {
            id: 2,
            hospitalNameForm: 'Teaching Hospital Kandy',
            vote: '111-1-5-2002(11) Service and Maintenance-Hospital',
            allocationAmount: 3000000,
            jobDescription: 'Laboratory Equipment Purchase',
            estimateAmount: 2900000,
            awardingAmount: 2800000,
            physicalProgress: 100,
            advanceAmount: 500000,
            bill1: 800000,
            bill2: 750000,
            bill3: 650000,
            bill4: 600000,
            bill5: 0,
            remark: 'Completed',
            createdDate: new Date(2023, 4, 10)
        },
        {
            id: 3,
            hospitalNameForm: 'Colombo South Teaching Hospital',
            vote: '111-1-5-2103(11) Machinery Purchasing-Hospitals',
            allocationAmount: 8000000,
            jobDescription: 'New ICU Construction',
            estimateAmount: 7800000,
            awardingAmount: 7500000,
            physicalProgress: 45,
            advanceAmount: 1500000,
            bill1: 1200000,
            bill2: 1100000,
            bill3: 800000,
            bill4: 0,
            bill5: 0,
            remark: 'Foundation work completed',
            createdDate: new Date(2023, 6, 1)
        },
        {
            id: 4,
            hospitalNameForm: 'Lady Ridgeway Hospital',
            vote: '111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions',
            allocationAmount: 2500000,
            jobDescription: 'Staff Quarters Repair',
            estimateAmount: 2400000,
            awardingAmount: 2200000,
            physicalProgress: 90,
            advanceAmount: 500000,
            bill1: 600000,
            bill2: 550000,
            bill3: 450000,
            bill4: 400000,
            bill5: 0,
            remark: 'Final phase',
            createdDate: new Date(2023, 5, 20)
        },
        {
            id: 5,
            hospitalNameForm: 'DGH Negombo (District General Hospital)',
            vote: '111-2-26-2001(11) Building Rehabilitation-Other Health Institutions',
            allocationAmount: 3500000,
            jobDescription: 'Pediatric Ward Expansion',
            estimateAmount: 3400000,
            awardingAmount: 3200000,
            physicalProgress: 60,
            advanceAmount: 700000,
            bill1: 500000,
            bill2: 450000,
            bill3: 400000,
            bill4: 0,
            bill5: 0,
            remark: 'On schedule',
            createdDate: new Date(2023, 6, 5)
        },
        {
            id: 6,
            hospitalNameForm: 'National Hospital Sri Lanka',
            vote: '111-2-26-2002(11) Service and Maintenance-Other Health Institutions',
            allocationAmount: 4200000,
            jobDescription: 'CT Scanner Installation',
            estimateAmount: 4100000,
            awardingAmount: 4000000,
            physicalProgress: 100,
            advanceAmount: 1000000,
            bill1: 1000000,
            bill2: 1000000,
            bill3: 1000000,
            bill4: 1000000,
            bill5: 0,
            remark: 'Completed and operational',
            createdDate: new Date(2023, 4, 25)
        }
    ];

    // Filter projects based on user type
    if (currentUser.type === 'hospital') {
        projects = projects.filter(project => project.hospitalNameForm === currentUser.name);
    }
}

// Filter and sort projects
function filterProjects() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const hospitalFilter = document.getElementById('hospitalFilter')?.value || '';
    const progressFilter = document.getElementById('progressFilter')?.value || '';
    const sortOption = document.getElementById('sortSelect')?.value || 'date-desc';
    
    filteredProjects = projects.filter(project => {
        // Search filter
        const matchesSearch = 
            project.hospitalNameForm.toLowerCase().includes(searchTerm) ||
            project.vote.toLowerCase().includes(searchTerm) ||
            project.jobDescription.toLowerCase().includes(searchTerm);
        
        // Hospital filter (admin only)
        const matchesHospital = hospitalFilter ? project.hospitalNameForm === hospitalFilter : true;
        
        // Progress filter
        let matchesProgress = true;
        if (progressFilter) {
            if (progressFilter === '100') {
                matchesProgress = project.physicalProgress === 100;
            } else if (progressFilter === '0-25') {
                matchesProgress = project.physicalProgress >= 0 && project.physicalProgress <= 25;
            } else if (progressFilter === '26-50') {
                matchesProgress = project.physicalProgress >= 26 && project.physicalProgress <= 50;
            } else if (progressFilter === '51-75') {
                matchesProgress = project.physicalProgress >= 51 && project.physicalProgress <= 75;
            } else if (progressFilter === '76-99') {
                matchesProgress = project.physicalProgress >= 76 && project.physicalProgress <= 99;
            }
        }
        
        return matchesSearch && matchesHospital && matchesProgress;
    });
    
    // Sort projects
    filteredProjects.sort((a, b) => {
        switch(sortOption) {
            case 'date-asc':
                return a.createdDate - b.createdDate;
            case 'date-desc':
                return b.createdDate - a.createdDate;
            case 'progress-asc':
                return a.physicalProgress - b.physicalProgress;
            case 'progress-desc':
                return b.physicalProgress - a.physicalProgress;
            case 'name-asc':
                return a.hospitalNameForm.localeCompare(b.hospitalNameForm);
            case 'name-desc':
                return b.hospitalNameForm.localeCompare(a.hospitalNameForm);
            default:
                return b.createdDate - a.createdDate;
        }
    });
    
    currentPage = 1;
    displayProjects();
    displayHospitalSummary();
}

// Display hospital summary
function displayHospitalSummary() {
    if (currentUser.type !== 'admin') {
        document.getElementById('hospitalSummary').innerHTML = '';
        return;
    }
    
    const hospitalFilter = document.getElementById('hospitalFilter').value;
    const hospitalProjects = hospitalFilter ? 
        projects.filter(p => p.hospitalNameForm === hospitalFilter) : 
        projects;
    
    if (hospitalProjects.length === 0) {
        document.getElementById('hospitalSummary').innerHTML = '';
        return;
    }
    
    const stats = hospitalProjects.reduce((acc, project) => {
        acc.totalProjects++;
        acc.totalAllocation += project.allocationAmount;
        acc.totalAwarded += project.awardingAmount;
        acc.totalBills += (project.bill1 || 0) + (project.bill2 || 0) + (project.bill3 || 0) + 
                          (project.bill4 || 0) + (project.bill5 || 0);
        acc.totalProgress += project.physicalProgress;
        if (project.physicalProgress === 100) acc.completedProjects++;
        return acc;
    }, {
        totalProjects: 0,
        totalAllocation: 0,
        totalAwarded: 0,
        totalBills: 0,
        totalProgress: 0,
        completedProjects: 0
    });
    
    const avgProgress = stats.totalProjects > 0 ? (stats.totalProgress / stats.totalProjects).toFixed(1) : 0;
    
    document.getElementById('hospitalSummary').innerHTML = `
        <div class="hospital-summary">
            <h3><i class="fas fa-hospital"></i> ${hospitalFilter || 'All Hospitals'} Summary</h3>
            <div class="summary-stats">
                <div>Total Projects: <span>${stats.totalProjects}</span></div>
                <div>Completed: <span>${stats.completedProjects}</span></div>
                <div>Allocation: <span>Rs. ${stats.totalAllocation.toLocaleString()}</span></div>
                <div>Awarded: <span>Rs. ${stats.totalAwarded.toLocaleString()}</span></div>
                <div>Payments: <span>Rs. ${stats.totalBills.toLocaleString()}</span></div>
                <div>Avg. Progress: <span>${avgProgress}%</span></div>
            </div>
        </div>
    `;
}

// Clear search and filters
function clearSearch() {
    document.getElementById('searchInput').value = '';
    if (document.getElementById('hospitalFilter')) {
        document.getElementById('hospitalFilter').value = '';
    }
    if (document.getElementById('progressFilter')) {
        document.getElementById('progressFilter').value = '';
    }
    filterProjects();
}

// Save Project Function
async function saveProject() {
    const formData = getFormData();
    
    if (!validateForm(formData)) {
        return;
    }

    try {
        showLoading(true);
        
        if (GAS_WEB_APP_URL && GAS_WEB_APP_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
            // Add ID if editing
            if (editingProject) {
                formData.id = editingProject.id;
            }

            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=saveProject&data=${encodeURIComponent(JSON.stringify(formData))}`
            });

            const result = await response.json();
            
            if (result.success) {
                await loadDashboard();
                closeModal();
                alert('Project saved successfully!');
            } else {
                alert(result.error || 'Save failed');
            }
        } else {
            // Local storage for demo
            saveProjectLocally(formData);
        }
    } catch (error) {
        console.error('Save error:', error);
        // Fall back to local storage
        saveProjectLocally(formData);
    } finally {
        showLoading(false);
    }
}

// Save project locally
function saveProjectLocally(formData) {
    if (editingProject) {
        // Update existing project
        const index = projects.findIndex(p => p.id === editingProject.id);
        if (index !== -1) {
            projects[index] = { ...formData, id: editingProject.id, createdDate: projects[index].createdDate };
        }
    } else {
        // Add new project
        const newId = Math.max(...projects.map(p => p.id), 0) + 1;
        projects.push({ ...formData, id: newId, createdDate: new Date() });
    }
    
    displayStats();
    filterProjects();
    closeModal();
    alert('Project saved successfully!');
}

// Get form data
function getFormData() {
    return {
        hospitalNameForm: document.getElementById('hospitalNameForm').value,
        vote: document.getElementById('vote').value,
        allocationAmount: parseFloat(document.getElementById('allocationAmount').value) || 0,
        jobDescription: document.getElementById('jobDescription').value,
        estimateAmount: parseFloat(document.getElementById('estimateAmount').value) || 0,
        awardingAmount: parseFloat(document.getElementById('awardingAmount').value) || 0,
        physicalProgress: parseFloat(document.getElementById('physicalProgress').value) || 0,
        advanceAmount: parseFloat(document.getElementById('advanceAmount').value) || 0,
        bill1: parseFloat(document.getElementById('bill1').value) || 0,
        bill2: parseFloat(document.getElementById('bill2').value) || 0,
        bill3: parseFloat(document.getElementById('bill3').value) || 0,
        bill4: parseFloat(document.getElementById('bill4').value) || 0,
        bill5: parseFloat(document.getElementById('bill5').value) || 0,
        remark: document.getElementById('remark').value
    };
}

// Display statistics
function displayStats() {
    const statsContainer = document.getElementById('dashboardStats');
    const totalProjects = projects.length;
    const completedProjects = projects.filter(p => p.physicalProgress === 100).length;
    const totalAllocation = projects.reduce((sum, p) => sum + p.allocationAmount, 0);
    const totalAwarded = projects.reduce((sum, p) => sum + p.awardingAmount, 0);
    const totalBills = projects.reduce((sum, p) => {
        return sum + (p.bill1 || 0) + (p.bill2 || 0) + (p.bill3 || 0) + (p.bill4 || 0) + (p.bill5 || 0);
    }, 0);
    const avgProgress = totalProjects > 0 ? projects.reduce((sum, p) => sum + p.physicalProgress, 0) / totalProjects : 0;

    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-project-diagram"></i></div>
            <div class="stat-number">${totalProjects}</div>
            <p>Total Projects</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-number">${completedProjects}</div>
            <p>Completed</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
            <div class="stat-number">Rs. ${(totalAllocation/1000000).toFixed(1)}M</div>
            <p>Total Allocation</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-trophy"></i></div>
            <div class="stat-number">Rs. ${(totalAwarded/1000000).toFixed(1)}M</div>
            <p>Total Awarded</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-receipt"></i></div>
            <div class="stat-number">Rs. ${(totalBills/1000000).toFixed(1)}M</div>
            <p>Total Payments</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
            <div class="stat-number">${avgProgress.toFixed(1)}%</div>
            <p>Avg Progress</p>
        </div>
    `;
}

// Display projects with pagination
function displayProjects() {
    const projectsContainer = document.getElementById('projectsGrid');
    const paginationContainer = document.getElementById('paginationControls');
    
    // Calculate pagination
    const startIndex = (currentPage - 1) * projectsPerPage;
    const endIndex = Math.min(startIndex + projectsPerPage, filteredProjects.length);
    const paginatedProjects = filteredProjects.slice(startIndex, endIndex);
    const totalPages = Math.ceil(filteredProjects.length / projectsPerPage);
    
    if (filteredProjects.length === 0) {
        projectsContainer.innerHTML = '<div class="no-results" style="text-align: center; padding: 40px; font-size: 1.2rem; color: var(--gray);"><i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px; display: block;"></i>No projects found matching your criteria.</div>';
        paginationContainer.innerHTML = '';
        return;
    }

    projectsContainer.innerHTML = paginatedProjects.map(project => {
        const totalBills = (project.bill1 || 0) + (project.bill2 || 0) + (project.bill3 || 0) + (project.bill4 || 0) + (project.bill5 || 0);
        const financialProgress = project.awardingAmount > 0 ? ((totalBills / project.awardingAmount) * 100) : 0;
        
        return `
            <div class="project-card">
                <div class="project-header">
                    <div>
                        <h3>${project.vote}</h3>
                        <span>${project.hospitalNameForm}</span>
                    </div>
                    <div class="project-actions">
                        ${currentUser.type === 'admin' || currentUser.name === project.hospitalNameForm ? 
                            `<button class="btn" onclick="editProject(${project.id})" style="padding: 8px 15px; font-size: 14px;"><i class="fas fa-edit"></i></button>
                             <button class="btn btn-secondary" onclick="deleteProject(${project.id})" style="padding: 8px 15px; font-size: 14px;"><i class="fas fa-trash"></i></button>` : 
                            ''
                        }
                    </div>
                </div>
                
                <p class="project-description">${project.jobDescription}</p>
                
                <div class="financial-summary">
                    <div class="financial-item">
                        <span>Allocation:</span>
                        <span>Rs. ${project.allocationAmount.toLocaleString()}</span>
                    </div>
                    <div class="financial-item">
                        <span>Awarded:</span>
                        <span>Rs. ${project.awardingAmount.toLocaleString()}</span>
                    </div>
                    <div class="financial-item">
                        <span>Bills Paid:</span>
                        <span>Rs. ${totalBills.toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-header">
                        <span>Physical Progress</span>
                        <span>${project.physicalProgress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${project.physicalProgress}%"></div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-header">
                        <span>Financial Progress</span>
                        <span>${financialProgress.toFixed(1)}%</span>
                    </div>
                    <div class="progress-bar financial-progress">
                        <div class="progress-fill" style="width: ${financialProgress}%"></div>
                    </div>
                </div>
                
                ${project.remark ? `<div class="project-remark"><strong>Remark:</strong> ${project.remark}</div>` : ''}
            </div>
        `;
    }).join('');
    
    let paginationHTML = '';

    if (totalPages > 1) {
        // Previous Button
        paginationHTML += `
            <button class="btn ${currentPage === 1 ? 'btn-outline' : ''}" 
                    onclick="changePage(${currentPage - 1})" 
                    ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        `;

        // Pages around current
        for (let i = Math.max(1, currentPage - 1); i <= Math.min(totalPages, currentPage + 1); i++) {
            paginationHTML += `
                <button class="btn ${i === currentPage ? 'btn-success' : 'btn-outline'}" 
                        onclick="changePage(${i})">
                    ${i}
                </button>
            `;
        }

        // Next Button
        paginationHTML += `
            <button class="btn ${currentPage === totalPages ? 'btn-outline' : ''}" 
                    onclick="changePage(${currentPage + 1})" 
                    ${currentPage === totalPages ? 'disabled' : ''}>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        `;
    }
    
    paginationContainer.innerHTML = paginationHTML;
}

// Change page function
function changePage(page) {
    currentPage = page;
    displayProjects();
}

// Modal functions
function openModal() {
    editingProject = null;
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-file-medical"></i> Add New Project';
    document.getElementById('projectForm').reset();
    
    // Set hospital name for non-admin users
    if (currentUser.type === 'hospital') {
        document.getElementById('hospitalNameForm').value = currentUser.name;
        document.getElementById('hospitalNameForm').disabled = true;
    } else {
        document.getElementById('hospitalNameForm').disabled = false;
    }
    
    document.getElementById('projectModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('projectModal').style.display = 'none';
    editingProject = null;
}

function editProject(id) {
    const project = projects.find(p => p.id === id);
    if (!project) return;

    editingProject = project;
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Project';
    
    // Populate form with project data
    document.getElementById('hospitalNameForm').value = project.hospitalNameForm;
    document.getElementById('vote').value = project.vote;
    document.getElementById('allocationAmount').value = project.allocationAmount;
    document.getElementById('jobDescription').value = project.jobDescription;
    document.getElementById('estimateAmount').value = project.estimateAmount;
    document.getElementById('awardingAmount').value = project.awardingAmount;
    document.getElementById('physicalProgress').value = project.physicalProgress;
    document.getElementById('advanceAmount').value = project.advanceAmount || '';
    document.getElementById('bill1').value = project.bill1 || '';
    document.getElementById('bill2').value = project.bill2 || '';
    document.getElementById('bill3').value = project.bill3 || '';
    document.getElementById('bill4').value = project.bill4 || '';
    document.getElementById('bill5').value = project.bill5 || '';
    document.getElementById('remark').value = project.remark || '';
    
    // Set hospital name restrictions for non-admin users
    if (currentUser.type === 'hospital') {
        document.getElementById('hospitalNameForm').disabled = true;
    } else {
        document.getElementById('hospitalNameForm').disabled = false;
    }
    
    document.getElementById('projectModal').style.display = 'flex';
}

// Delete Project Function
async function deleteProject(id) {
    if (!confirm('Are you sure you want to delete this project?')) {
        return;
    }

    try {
        showLoading(true);
        
        if (GAS_WEB_APP_URL && GAS_WEB_APP_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=deleteProject&data=${encodeURIComponent(JSON.stringify({ id: id }))}`
            });

            const result = await response.json();
            
            if (result.success) {
                await loadDashboard();
                alert('Project deleted successfully!');
            } else {
                alert(result.error || 'Delete failed');
            }
        } else {
            // Local delete for demo
            projects = projects.filter(p => p.id !== id);
            displayStats();
            filterProjects();
            alert('Project deleted successfully!');
        }
    } catch (error) {
        console.error('Delete error:', error);
        // Fall back to local delete
        projects = projects.filter(p => p.id !== id);
        displayStats();
        filterProjects();
        alert('Project deleted successfully!');
    } finally {
        showLoading(false);
    }
}

// Load analytics data
function loadAnalytics() {
    if (!currentUser || currentUser.type !== 'admin') return;
    
    const hospitalFilter = document.getElementById('analyticsHospitalFilter').value;
    const filtered = hospitalFilter ? projects.filter(p => p.hospitalNameForm === hospitalFilter) : projects;
    
    // Update hospital filter dropdown
    populateAnalyticsHospitalFilter();
    
    // Destroy existing charts if they exist
    if (hospitalChart) hospitalChart.destroy();
    if (progressChart) progressChart.destroy();
    if (financialChart) financialChart.destroy();
    if (progressDistributionChart) progressDistributionChart.destroy();
    
    // Projects by Hospital
    if (!hospitalFilter) {
        const hospitals = [...new Set(projects.map(p => p.hospitalNameForm))];
        const counts = hospitals.map(hospital => 
            projects.filter(p => p.hospitalNameForm === hospital).length
        );
        
        const ctx1 = document.getElementById('hospitalChart').getContext('2d');
        hospitalChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: hospitals,
                datasets: [{
                    label: 'Number of Projects',
                    data: counts,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('hospitalChart').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--gray);">Select "All Hospitals" to see distribution by hospital</p>';
    }
    
    // Projects by Progress
    const progressRanges = [
        { label: '0-25%', min: 0, max: 25 },
        { label: '26-50%', min: 26, max: 50 },
        { label: '51-75%', min: 51, max: 75 },
        { label: '76-99%', min: 76, max: 99 },
        { label: '100%', min: 100, max: 100 }
    ];
    
    const progressCounts = progressRanges.map(range => 
        filtered.filter(p => p.physicalProgress >= range.min && p.physicalProgress <= range.max).length
    );
    
    const ctx2 = document.getElementById('progressChart').getContext('2d');
    progressChart = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: progressRanges.map(r => r.label),
            datasets: [{
                data: progressCounts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Financial Allocation vs Spending
    const hospitalsForFinance = [...new Set(filtered.map(p => p.hospitalNameForm))];
    const allocationData = hospitalsForFinance.map(hospital => 
        filtered.filter(p => p.hospitalNameForm === hospital)
            .reduce((sum, p) => sum + p.allocationAmount, 0)
    );
    
    const spendingData = hospitalsForFinance.map(hospital => 
        filtered.filter(p => p.hospitalNameForm === hospital)
            .reduce((sum, p) => sum + (p.bill1 || 0) + (p.bill2 || 0) + (p.bill3 || 0) + (p.bill4 || 0) + (p.bill5 || 0), 0)
    );
    
    const ctx3 = document.getElementById('financialChart').getContext('2d');
    financialChart = new Chart(ctx3, {
        type: 'bar',
        data: {
            labels: hospitalsForFinance,
            datasets: [
                {
                    label: 'Allocation',
                    data: allocationData,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Spending',
                    data: spendingData,
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Progress Distribution
    const progressData = filtered.map(p => p.physicalProgress);
    const ctx4 = document.getElementById('progressDistributionChart').getContext('2d');
    progressDistributionChart = new Chart(ctx4, {
        type: 'line',
        data: {
            labels: filtered.map((_, i) => `Project ${i + 1}`),
            datasets: [{
                label: 'Physical Progress',
                data: progressData,
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 2,
                pointRadius: 4,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

// Populate analytics hospital filter
function populateAnalyticsHospitalFilter() {
    const filter = document.getElementById('analyticsHospitalFilter');
    if (filter.options.length > 1) return; // already populated
    
    const hospitals = [...new Set(projects.map(p => p.hospitalNameForm))];
    hospitals.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital;
        option.textContent = hospital;
        filter.appendChild(option);
    });
}

// Export to Excel Function - Fixed Version
async function exportToExcel() {
    try {
        showLoading(true);
        
        if (GAS_WEB_APP_URL && GAS_WEB_APP_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=exportProjectsToCSV&data=${encodeURIComponent(JSON.stringify({
                    userType: currentUser.type,
                    hospitalName: currentUser.name
                }))}`
            });

            // Check if response is ok
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success && result.csv) {
                // Create and download CSV file
                const blob = new Blob([result.csv], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = currentUser.type === 'admin' ? 
                    'All_Hospital_Projects.csv' : 
                    `${currentUser.name.replace(/[^a-zA-Z0-9]/g, '_')}_Projects.csv`;
                
                // Append to body, click, and cleanup
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                console.log('CSV export successful');
            } else {
                throw new Error(result.error || 'Export failed - no data received');
            }
        } else {
            console.log('Using local export fallback');
            // Local export using XLSX library
            exportToExcelLocal();
        }
    } catch (error) {
        console.error('Export error:', error);
        alert(`Export successful: ${error.message}`);
        
        // Fall back to local export
        try {
            exportToExcelLocal();
        } catch (localError) {
            console.error('Local export also failed:', localError);
            alert('Both remote and local export failed. Please check console for details.');
        }
    } finally {
        showLoading(false);
    }
}

// Alternative: Direct Excel export using XLSX library
function exportToExcelLocal() {
    try {
        // Make sure XLSX library is loaded
        if (typeof XLSX === 'undefined') {
            throw new Error('XLSX library not loaded. Please include SheetJS library.');
        }

        // Get your data (replace this with your actual data source)
        let data = [];
        
        // Example: If you have projects data
        if (typeof projects !== 'undefined' && Array.isArray(projects)) {
            data = projects.map(project => ({
                'Hospital Name': project.hospitalNameForm,
                'Vote': project.vote,
                'Job Description': project.jobDescription,
                'Allocation Amount': project.allocationAmount,
                'Estimate Amount': project.estimateAmount,
                'Awarding Amount': project.awardingAmount,
                'Physical Progress': project.physicalProgress + '%',
                'Advance Amount': project.advanceAmount || 0,
                '1st Bill': project.bill1 || 0,
                '2nd Bill': project.bill2 || 0,
                '3rd Bill': project.bill3 || 0,
                '4th Bill': project.bill4 || 0,
                '5th Bill': project.bill5 || 0,
                'Remark': project.remark || ''
            }));
        } else if (typeof currentUser !== 'undefined' && currentUser.projects) {
            data = currentUser.projects;
        } else {
            throw new Error('No data found to export');
        }

        if (data.length === 0) {
            alert('No data available to export');
            return;
        }

        // Create workbook and worksheet
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(data);

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Projects');

        // Generate filename
        const filename = currentUser?.type === 'admin' ? 
            'All_Hospital_Projects.xlsx' : 
            `${(currentUser?.name || 'Projects').replace(/[^a-zA-Z0-9]/g, '_')}_Projects.xlsx`;

        // Write and download file
        XLSX.writeFile(workbook, filename);
        
        console.log('Local Excel export successful');
    } catch (error) {
        console.error('Local export error:', error);
        throw error;
    }
}

// Load Vote Dashboard - FIXED
function loadVoteDashboard() {
    if (!currentUser || currentUser.type !== 'admin') return;
    
    const voteFilter = document.getElementById('voteFilter').value;
    
    // Aggregate data by vote
    let voteData = {};
    projects.forEach(project => {
        // If vote filter is set and doesn't match, skip
        if (voteFilter && project.vote !== voteFilter) return;
        
        if (!voteData[project.vote]) {
            voteData[project.vote] = {
                vote: project.vote,
                projects: 0,
                allocation: 0,
                awarded: 0,
                bills: 0,
                progress: 0,
                progressTotal: 0, // for weighted average
                weight: 0          // total allocation for weighting
            };
        }
        
        let vote = voteData[project.vote];
        vote.projects++;
        vote.allocation += project.allocationAmount;
        vote.awarded += project.awardingAmount;
        vote.bills += (project.bill1 || 0) + (project.bill2 || 0) + (project.bill3 || 0) +
                     (project.bill4 || 0) + (project.bill5 || 0);
        // For progress: we'll do a weighted average by allocation
        vote.progressTotal += project.physicalProgress * project.allocationAmount;
        vote.weight += project.allocationAmount;
    });
    
    // Calculate weighted progress
    Object.keys(voteData).forEach(voteKey => {
        let vote = voteData[voteKey];
        vote.progress = vote.weight > 0 ? (vote.progressTotal / vote.weight) : 0;
    });
    
    // Convert to array for display
    const voteSummary = Object.values(voteData);
    
    // Populate vote table
    const voteTableBody = document.querySelector('#voteTable tbody');
    voteTableBody.innerHTML = '';
    
    voteSummary.forEach(vote => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="font-size: 0.8rem;">${vote.vote}</td>
            <td>${vote.projects}</td>
            <td>Rs. ${vote.allocation.toLocaleString()}</td>
            <td>Rs. ${vote.awarded.toLocaleString()}</td>
            <td>Rs. ${vote.bills.toLocaleString()}</td>
            <td>${vote.progress.toFixed(1)}%</td>
        `;
        voteTableBody.appendChild(row);
    });
    
    // Populate vote stats
    const voteStatsContainer = document.getElementById('voteStats');
    voteStatsContainer.innerHTML = '';
    
    const totalVotes = voteSummary.length;
    const totalAllocation = voteSummary.reduce((sum, v) => sum + v.allocation, 0);
    const totalAwarded = voteSummary.reduce((sum, v) => sum + v.awarded, 0);
    const totalBills = voteSummary.reduce((sum, v) => sum + v.bills, 0);
    const avgProgress = voteSummary.length > 0 ? 
        voteSummary.reduce((sum, v) => sum + v.progress, 0) / voteSummary.length : 0;
    
    voteStatsContainer.innerHTML = `
        <div class="vote-stat">
            <h4>Total Votes</h4>
            <div class="value">${totalVotes}</div>
        </div>
        <div class="vote-stat">
            <h4>Total Allocation</h4>
            <div class="value">Rs. ${(totalAllocation/1000000).toFixed(1)}M</div>
        </div>
        <div class="vote-stat">
            <h4>Total Awarded</h4>
            <div class="value">Rs. ${(totalAwarded/1000000).toFixed(1)}M</div>
        </div>
        <div class="vote-stat">
            <h4>Total Bills Paid</h4>
            <div class="value">Rs. ${(totalBills/1000000).toFixed(1)}M</div>
        </div>
        <div class="vote-stat">
            <h4>Avg Progress</h4>
            <div class="value">${avgProgress.toFixed(1)}%</div>
        </div>
    `;
    
    // Update vote filter dropdown
    populateVoteFilter();
    
    // Draw vote chart
    if (voteChart) voteChart.destroy();
    
    if (voteSummary.length > 0) {
        const ctx = document.getElementById('voteChart').getContext('2d');
        
        // Prepare chart data
        const labels = voteSummary.map(v => v.vote.length > 30 ? v.vote.substring(0, 30) + '...' : v.vote);
        const data = voteSummary.map(v => v.allocation);
        const colors = generateChartColors(data.length);
        
        voteChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const fullLabel = voteSummary[context.dataIndex].vote;
                                const value = context.parsed;
                                return fullLabel + ': Rs. ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
}

// Generate colors for chart
function generateChartColors(count) {
    const colors = [];
    const baseColors = [
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 99, 132, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)',
        'rgba(199, 199, 199, 0.7)',
        'rgba(83, 102, 255, 0.7)',
        'rgba(40, 159, 64, 0.7)',
        'rgba(210, 99, 132, 0.7)'
    ];
    
    for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
    }
    
    return colors;
}

// Populate vote filter dropdown
function populateVoteFilter() {
    const filter = document.getElementById('voteFilter');
    if (filter.options.length > 1) return; // already populated
    
    const votes = [...new Set(projects.map(p => p.vote))];
    votes.forEach(vote => {
        const option = document.createElement('option');
        option.value = vote;
        option.textContent = vote;
        filter.appendChild(option);
    });
}

// Export Vote Summary to Excel
function exportVoteSummaryToExcel() {
    try {
        showLoading(true);
        
        // Aggregate data by vote
        let voteData = {};
        projects.forEach(project => {
            if (!voteData[project.vote]) {
                voteData[project.vote] = {
                    vote: project.vote,
                    projects: 0,
                    allocation: 0,
                    awarded: 0,
                    bills: 0,
                    progress: 0,
                    progressTotal: 0,
                    weight: 0
                };
            }
            
            let vote = voteData[project.vote];
            vote.projects++;
            vote.allocation += project.allocationAmount;
            vote.awarded += project.awardingAmount;
            vote.bills += (project.bill1 || 0) + (project.bill2 || 0) + (project.bill3 || 0) +
                         (project.bill4 || 0) + (project.bill5 || 0);
            vote.progressTotal += project.physicalProgress * project.allocationAmount;
            vote.weight += project.allocationAmount;
        });
        
        // Calculate weighted progress
        Object.keys(voteData).forEach(voteKey => {
            let vote = voteData[voteKey];
            vote.progress = vote.weight > 0 ? (vote.progressTotal / vote.weight) : 0;
        });
        
        // Convert to array
        const voteSummary = Object.values(voteData);
        
        // Prepare data for export
        const dataForExport = voteSummary.map(vote => ({
            'Vote Number': vote.vote,
            'Projects': vote.projects,
            'Allocation (Rs.)': vote.allocation,
            'Awarded (Rs.)': vote.awarded,
            'Bills Paid (Rs.)': vote.bills,
            'Progress (%)': vote.progress.toFixed(1)
        }));
        
        // Create worksheet
        const ws = XLSX.utils.json_to_sheet(dataForExport);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Vote Summary");
        
        // Generate filename
        const filename = 'Vote_Summary.xlsx';
        
        // Write and download file
        XLSX.writeFile(wb, filename);
        
        console.log('Vote summary Excel export successful');
        alert('Vote summary exported successfully!');
    } catch (error) {
        console.error('Vote summary export error:', error);
        alert('Vote summary export failed: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Logout function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        projects = [];
        filteredProjects = [];
        
        // Reset charts
        if (hospitalChart) hospitalChart.destroy();
        if (progressChart) progressChart.destroy();
        if (financialChart) financialChart.destroy();
        if (progressDistributionChart) progressDistributionChart.destroy();
        if (voteChart) voteChart.destroy();
        
        // Reset filters
        document.getElementById('voteFilter').innerHTML = '<option value="">All Votes</option>';
        
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('hospitalName').value = '';
        document.getElementById('password').value = '';
        
        // Show dashboard by default
        showSection('dashboard');
    }
}

// Loading indicator functions
function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (show) {
        loadingIndicator.style.display = 'flex';
    } else {
        loadingIndicator.style.display = 'none';
    }
}

// Enhanced form validation
function validateForm(data) {
    const requiredFields = [
        { field: 'hospitalNameForm', name: 'Hospital Name' },
        { field: 'vote', name: 'Vote' },
        { field: 'jobDescription', name: 'Job Description' },
        { field: 'allocationAmount', name: 'Allocation Amount' },
        { field: 'estimateAmount', name: 'Estimate Amount' },
        { field: 'awardingAmount', name: 'Awarding Amount' },
        { field: 'physicalProgress', name: 'Physical Progress' }
    ];

    for (const req of requiredFields) {
        if (data[req.field] === undefined || data[req.field] === null || data[req.field] === '') {
            alert(`Please fill in ${req.name}`);
            return false;
        }
    }

    // Validate numeric fields
    const numericFields = ['allocationAmount', 'estimateAmount', 'awardingAmount', 'physicalProgress',
                        'advanceAmount', 'bill1', 'bill2', 'bill3', 'bill4', 'bill5'];
    for (const field of numericFields) {
        if (data[field] !== undefined && data[field] !== null && data[field] !== '') {
            if (isNaN(data[field]) || data[field] < 0) {
                alert(`${field} must be a valid positive number`);
                return false;
            }
        }
    }

    // Validate progress percentage
    if (data.physicalProgress < 0 || data.physicalProgress > 100) {
        alert('Physical progress must be between 0 and 100');
        return false;
    }

    return true;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('projectModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Handle Enter key for login
document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter' && !document.getElementById('loginForm').classList.contains('hidden')) {
        login();
    }
});

// Initialize the application when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Hospital Project Management System initialized');
    
    // Focus on hospital name dropdown
    document.getElementById('hospitalName').focus();
    
    // Initialize loading indicator as hidden
    showLoading(false);
});
    </script>
</body>

</html>






